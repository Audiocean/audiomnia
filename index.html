<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
          crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/css/ol.css">
    <style>
      .map { height: 400px; width: 100%; }
    </style>

    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/build/ol.js"></script>
    <script src="./js/querystring.min.js"></script>

    <title>Audiomnia</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light">
        <a class="navbar-brand" href="#">Audiomnia</a>
        <button class="navbar-toggler" type="button"
                data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="?birds">
                Birds<span class="sr-only">(current)</span>
              </a>
            </li>
            <li class="nav-item disabled">
              <a class="nav-link" href="?marine">
                Marine <small>(coming soon)</small>
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- <div class="row">
        <div class="col-md-12">
          <form class="form-inline my-2 my-lg-2">
            <input class="form-control mr-sm-2" id="search" type="search" placeholder="Filter by creator or species" aria-label="Filter by creator or species">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Filter</button>
            &nbsp;<button class="btn btn-info">Linda Macaulay ×</button>
            &nbsp;<button class="btn btn-warning">Malachite Sunbird <em>Nectarinia famosa</em> ×</button>
          </form>
        </div>
      </div> -->

      <div class="row">
        <div class="col-md-12">
          <div id="map" class="map"></div>
        </div>
      </div>

      <div class="row" id="results"></div>

      <footer style="margin-top: 1em">
        Source code available on <a href="https://github.com/hackforthesea/audiomnia">GitHub</a>.
      </footer>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var qs = querystring.parse();
      if(qs.hasOwnProperty('birds') && qs.hasOwnProperty('marine')) {
        window.location = "?birds"
      }

      var mapDiv = document.getElementById('map');

      async function renderResults(feature) {
        const props = feature.getProperties()

        const url = props.url
        const img = props.image
        const desc = props.description
        const name = desc[1]
        const sciName = desc[2]
        const audio = props.audio
        const libraryIdentifier = desc[0]
        const copyright = desc[3]
        const location = desc[4]
        const datetime = desc[5]

        const res = await fetch(`https://api.inaturalist.org/v1/taxa?q=${name}`)
        const image = (await res.json()).results[0].default_photo.medium_url

        let template = `<div class="col-md-4 card">`
        template += `     <img class="card-img-top" src="${image}" alt="" />`
        template += `     <div class="card-body">`
        template += `       <div class="card-title"><a href="${url}">${name}<br /><small>(${sciName})</small></a></div>`
        template += `       <audio controls><source src="${audio}"></audio>`
        template += `       <div class="card-text">${libraryIdentifier}</div>`
        template += `       <div class="card-text">${copyright}</div>`
        template += `       <div class="card-text">${location}</div>`
        template += `       <div class="card-text">${datetime}</div>`
        template += `     </div>`
        template += `   </div>`

        $('#results').append(template)
      }

      function renderMap(params) {
        mapDiv.innerHTML = "";
        var map = new ol.Map({
          layers: [
            new ol.layer.Tile({
              source: new ol.source.TileWMS({
                url: 'https://www.gebco.net/data_and_products/gebco_web_services/web_map_service/mapserv',
                params: {'LAYERS': 'GEBCO_LATEST', 'TILED': true},
                serverType: 'geoserver',
                // Countries have transparency, so do not fade tiles:
                transition: 0
              })
            }),
            new ol.layer.Vector({
              source: new ol.source.Vector({
                format: new ol.format.GeoJSON({
                  featureProjection:"EPSG:3857"
                }),
                url: "./data/macaulaylibrary.geojson"
              })
            })
          ],
          target: document.getElementById('map'),
          view: new ol.View({
            center: [0, 0],
            zoom: 1
          })
        });

        map.addEventListener("click", function(e) {
          const features = this.getFeaturesAtPixel(e.pixel)
            .filter(f => !(f.type === "VECTOR"))

          $("#results").html("");
          Promise.all(features.map(renderResults));
        })
      }

      renderMap();
    </script>
  </body>
</html>
